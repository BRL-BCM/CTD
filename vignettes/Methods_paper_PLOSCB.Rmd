---
title: "Methods Paper (Data from Miller et al., 2015)"
author: "Lillian Thistlethwaite"
date: "3/19/2019"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/lillian.rosa/OneDrive/MacFiles/9thCommitteeMeeting/Methods_paper/")
```

## Data Load
Untargeted metabolomics profiles from Miller et al. (2015)
```{r get-data}
require(CTD)
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
# import data and delete metabolite annotations.

cohorts = list()
cohorts$mcc = diagnoses$id[which(diagnoses$diagnosis=="3-methylcrotonyl CoA carboxylase")]
cohorts$arg = diagnoses$id[which(diagnoses$diagnosis=="Argininemia")]
cohorts$cit = diagnoses$id[which(diagnoses$diagnosis=="Citrullinemia")]
cohorts$cob = diagnoses$id[which(diagnoses$diagnosis=="Cobalamin biosynthesis")]
cohorts$ga = diagnoses$id[which(diagnoses$diagnosis=="Glutaric Aciduria")]
cohorts$gamt = diagnoses$id[which(diagnoses$diagnosis=="Guanidinoacetate methyltransferase")]
cohorts$msud = diagnoses$id[which(diagnoses$diagnosis=="Maple syrup urine disease")]
cohorts$mma = diagnoses$id[which(diagnoses$diagnosis=="Methylmalonic aciduria")]
cohorts$otc = diagnoses$id[which(diagnoses$diagnosis=="Ornithine transcarbamoylase")]
cohorts$pa = diagnoses$id[which(diagnoses$diagnosis=="Propionic aciduria")]
cohorts$pku = diagnoses$id[which(diagnoses$diagnosis=="Phenylketonuria")]
cohorts$tmhle = diagnoses$id[which(diagnoses$diagnosis=="Trimethyllysine hydroxylase epsilon")]

```

## Plot Patient's Metabolomic Profiles onto Pathway Maps
``` {r pathway-vis}
# CIT patients
setwd("pathwayVis/")
diagnoses[which(diagnoses$diagnosis=="Citrullinemia"), "id"]
#plot.pathwayMap("allPathways", "IEM_1016", data_mx[,"IEM_1016"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1017", data_mx[,"IEM_1017"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1018", data_mx[,"IEM_1018"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1019", data_mx[,"IEM_1019"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1020", data_mx[,"IEM_1020"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1021", data_mx[,"IEM_1021"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1022", data_mx[,"IEM_1022"], 2, 1, getwd())
plot.pathwayMap("allPathways", "IEM_1023", data_mx[,"IEM_1023"], 2, 1, getwd())  ## Cleanest CIT patient ##
#plot.pathwayMap("allPathways", "IEM_1024", data_mx[,"IEM_1024"], 2, 1, getwd())
# GAMT patients - None look amazing.
#diagnoses[which(diagnoses$diagnosis=="Guanidinoacetate methyltransferase"), "id"] 
#plot.pathwayMap("allPathways", "IEM_1030", data_mx[,"IEM_1030"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1031", data_mx[,"IEM_1031"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1032", data_mx[,"IEM_1032"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1033", data_mx[,"IEM_1033"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1034", data_mx[,"IEM_1034"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1035", data_mx[,"IEM_1035"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1036", data_mx[,"IEM_1036"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1037", data_mx[,"IEM_1037"], 2, 1, getwd())
# PKU patients
#ind = diagnoses[which(diagnoses$diagnosis=="Phenylketonuria"), "id"]
#mn_pku = apply(data_mx[,which(colnames(data_mx) %in% ind)], 1, mean)
#plot.pathwayMap("allPathways", "mnPKU", mn_pku, 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1102", data_mx[,"IEM_1102"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1103", data_mx[,"IEM_1103"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1104", data_mx[,"IEM_1104"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1105", data_mx[,"IEM_1105"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1106", data_mx[,"IEM_1106"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1107", data_mx[,"IEM_1107"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1108", data_mx[,"IEM_1108"], 2, 1, getwd())
#plot.pathwayMap("allPathways", "IEM_1109", data_mx[,"IEM_1109"], 2, 1, getwd())
```

## Interpret Patient Metabolomics Profiles with Over-Representation Analysis
``` {r ora}
# CIT patients: selected IEM_1017 for visualization
stats.getORA_Metabolon(data_mx[,"IEM_1017"], threshold = 2, type = "zscore")
# MSUD patients: Selected IEM_1058 for visualization
stats.getORA_Metabolon(data_mx[,"IEM_1058"], threshold = 2, type = "zscore")
# MMA patients: Selected IEM_1051 for visualization
stats.getORA_Metabolon(data_mx[,"IEM_1051"], threshold = 2, type = "zscore")
# PA patients: Selected IEM_1093 for visualization
stats.getORA_Metabolon(data_mx[,"IEM_1093"], threshold = 2, type = "zscore")
# PKU patients: selected IEM_1105 for visualization
stats.getORA_Metabolon(data_mx[,"IEM_1105"], threshold = 2, type = "zscore")

```

## Interpret Patient Metabolomics Profiles with Metabolite-Set Enrichment Analysis
``` {r msea}
setwd("/Users/lillian.rosa/OneDrive/MacFiles/9thCommitteeMeeting/Methods_paper/msea/")
# To learn how to build a pathway pathway knowledgebase GMT file, see msea_custom.Rmd

#### CIT patients ####
require(CTD)
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
data_mx = suppressWarnings(apply(data_mx, c(1,2), as.numeric))
fill = 1-(Miller2015$`Times identifed in all 200 samples`/200)
data_mx = data_mx[which(fill<=0.20),]
data_mx = data_mx[-grep("x - ", rownames(data_mx)),]
diags = diagnoses$diagnosis
data_mx2 = cbind(rep(NA, nrow(data_mx)), data_mx)
colnames(data_mx2)[1] = "DESCRIPTION"
write.table(data_mx2, file="Heparin_cit.gct", sep="\t", quote=FALSE, row.names = TRUE)
abs_filename_dataset = "Heparin_cit.gct"
# Or, if you want to save your dataset (.gct) for re-use, save them in the extdata folder of your CTD installation itself!
#write.table(data_mx2, file=system.file("extdata/MSEA_Datasets/Heparin_cit.gct", package="CTD"), sep="\t", quote=FALSE, row.names = TRUE)
#abs_filename_dataset = system.file("extdata/MSEA_Datasets/Heparin_cit.gct", package="CTD")

diag.ind = diags
diag.ind[-grep("Citrullinemia", diag.ind)] = 0
diag.ind[grep("Citrullinemia", diag.ind)] = 1
diag.ind = as.numeric(diag.ind)
diag.ind[which(diag.ind==1)] = "D"
diag.ind[which(diag.ind==0)] = "C"
diag.ind = paste(diag.ind, collapse=" ")
# Add num_samples 1 2, where num_samples is a numeric value equal to the nrow(data_mx2)-1
# Add #disease control
write.table(diag.ind, file="Heparin_cit.cls", sep=" ", quote=FALSE, row.names = FALSE, col.names = FALSE)
abs_filename_classes = "Heparin_cit.cls"
# Or, if you want to save your class labels (.cls) for re-use, save them in the extdata folder of your CTD installation itself! 
## CAUTION: Make sure you go back into it and add those 2 lines though.
#write.table(diag.ind, file=system.file("extdata/MSEA_Datasets/Heparin_cit.cls", package="CTD"), sep=" ", quote=FALSE, row.names = FALSE, col.names = FALSE)
#abs_filename_classes = system.file("extdata/MSEA_Datasets/Heparin_cit.cls", package="CTD")

# CIT patients
cit_msea = stats.getMSEA_Metabolon(abs_filename_dataset, abs_filename_classes, pathway_knowledgebase = "Metabolon", output_dir = getwd(), expt_name="cit")
cit_msea = cit_msea$report2[,c("MS", "SIZE", "NES", "NOM p-val", "FDR q-val")]
cit_msea[order(cit_msea$`FDR q-val`, decreasing = FALSE), ]


#### MSUD patients ####
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
data_mx = suppressWarnings(apply(data_mx, c(1,2), as.numeric))
fill = 1-(Miller2015$`Times identifed in all 200 samples`/200)
data_mx = data_mx[which(fill<=0.20),]
data_mx = data_mx[-grep("x - ", rownames(data_mx)),]
diags = diagnoses$diagnosis
data_mx2 = cbind(rep(NA, nrow(data_mx)), data_mx)
colnames(data_mx2)[1] = "DESCRIPTION"
write.table(data_mx2, file="Heparin_msud.gct", sep="\t", quote=FALSE, row.names = TRUE)
abs_filename_dataset = "Heparin_msud.gct"
diag.ind = diags
diag.ind[-grep("Maple syrup urine disease", diag.ind)] = 0
diag.ind[grep("Maple syrup urine disease", diag.ind)] = 1
diag.ind = as.numeric(diag.ind)
diag.ind[which(diag.ind==1)] = "D"
diag.ind[which(diag.ind==0)] = "C"
diag.ind = paste(diag.ind, collapse=" ")
# Add num_samples 1 2, where num_samples is a numeric value equal to the nrow(data_mx2)-1
# Add #disease control
write.table(diag.ind, file="Heparin_msud.cls", sep=" ", quote=FALSE, row.names = FALSE, col.names = FALSE)
abs_filename_classes = "Heparin_msud.cls"
# CIT patients
msud_msea = stats.getMSEA_Metabolon(abs_filename_dataset, abs_filename_classes, pathway_knowledgebase = "Metabolon", output_dir = getwd(), expt_name="msud")
msud_msea = msud_msea$report2[,c("MS", "SIZE", "NES", "NOM p-val", "FDR q-val")]
msud_msea[order(msud_msea$`NOM p-val`, decreasing = FALSE), ]


#### MMA patients ####
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
data_mx = suppressWarnings(apply(data_mx, c(1,2), as.numeric))
fill = 1-(Miller2015$`Times identifed in all 200 samples`/200)
data_mx = data_mx[which(fill<=0.20),]
data_mx = data_mx[-grep("x - ", rownames(data_mx)),]
diags = diagnoses$diagnosis
data_mx2 = cbind(rep(NA, nrow(data_mx)), data_mx)
colnames(data_mx2)[1] = "DESCRIPTION"
write.table(data_mx2, file="Heparin_mma.gct", sep="\t", quote=FALSE, row.names = TRUE)
abs_filename_dataset = "Heparin_mma.gct"
diag.ind = diags
diag.ind[-grep("Methylmalonic aciduria", diag.ind)] = 0
diag.ind[grep("Methylmalonic aciduria", diag.ind)] = 1
diag.ind = as.numeric(diag.ind)
diag.ind[which(diag.ind==1)] = "D"
diag.ind[which(diag.ind==0)] = "C"
diag.ind = paste(diag.ind, collapse=" ")
# Add num_samples 1 2, where num_samples is a numeric value equal to the nrow(data_mx2)-1
# Add #disease control
write.table(diag.ind, file="Heparin_mma.cls", sep=" ", quote=FALSE, row.names = FALSE, col.names = FALSE)
abs_filename_classes = "Heparin_mma.cls"
# CIT patients
mma_msea = stats.getMSEA_Metabolon(abs_filename_dataset, abs_filename_classes, pathway_knowledgebase = "Metabolon", output_dir = getwd(), expt_name="mma")
mma_msea = mma_msea$report2[,c("MS", "SIZE", "NES", "NOM p-val", "FDR q-val")]
mma_msea[order(mma_msea$`NOM p-val`, decreasing = FALSE), ]

#### PA patients ####
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
data_mx = suppressWarnings(apply(data_mx, c(1,2), as.numeric))
fill = 1-(Miller2015$`Times identifed in all 200 samples`/200)
data_mx = data_mx[which(fill<=0.20),]
data_mx = data_mx[-grep("x - ", rownames(data_mx)),]
diags = diagnoses$diagnosis
data_mx2 = cbind(rep(NA, nrow(data_mx)), data_mx)
colnames(data_mx2)[1] = "DESCRIPTION"
write.table(data_mx2, file="Heparin_pa.gct", sep="\t", quote=FALSE, row.names = TRUE)
abs_filename_dataset = "Heparin_pa.gct"
diag.ind = diags
diag.ind[-grep("Propionic aciduria", diag.ind)] = 0
diag.ind[grep("Propionic aciduria", diag.ind)] = 1
diag.ind = as.numeric(diag.ind)
diag.ind[which(diag.ind==1)] = "D"
diag.ind[which(diag.ind==0)] = "C"
diag.ind = paste(diag.ind, collapse=" ")
# Add num_samples 1 2, where num_samples is a numeric value equal to the nrow(data_mx2)-1
# Add #disease control
write.table(diag.ind, file="Heparin_pa.cls", sep=" ", quote=FALSE, row.names = FALSE, col.names = FALSE)
abs_filename_classes = "Heparin_pa.cls"
# CIT patients
pa_msea = stats.getMSEA_Metabolon(abs_filename_dataset, abs_filename_classes, pathway_knowledgebase = "Metabolon", output_dir = getwd(), expt_name="pa")
pa_msea = pa_msea$report2[,c("MS", "SIZE", "NES", "NOM p-val", "FDR q-val")]
pa_msea[order(pa_msea$`NOM p-val`, decreasing = FALSE), ]

#### PKU patients ####
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
data_mx = suppressWarnings(apply(data_mx, c(1,2), as.numeric))
fill = 1-(Miller2015$`Times identifed in all 200 samples`/200)
data_mx = data_mx[which(fill<=0.20),]
data_mx = data_mx[-grep("x - ", rownames(data_mx)),]
diags = diagnoses$diagnosis
data_mx2 = cbind(rep(NA, nrow(data_mx)), data_mx)
colnames(data_mx2)[1] = "DESCRIPTION"
write.table(data_mx2, file="Heparin_pku.gct", sep="\t", quote=FALSE, row.names = TRUE)
abs_filename_dataset = "Heparin_pku.gct"
diag.ind = diags
diag.ind[-grep("Phenylketonuria", diag.ind)] = 0
diag.ind[grep("Phenylketonuria", diag.ind)] = 1
diag.ind = as.numeric(diag.ind)
diag.ind[which(diag.ind==1)] = "D"
diag.ind[which(diag.ind==0)] = "C"
diag.ind = paste(diag.ind, collapse=" ")
# Add num_samples 1 2, where num_samples is a numeric value equal to the nrow(data_mx2)-1
# Add #disease control
write.table(diag.ind, file="Heparin_pku.cls", sep=" ", quote=FALSE, row.names = FALSE, col.names = FALSE)
abs_filename_classes = "Heparin_pku.cls"
# CIT pkutients
pku_msea = stats.getMSEA_Metabolon(abs_filename_dataset, abs_filename_classes, pathway_knowledgebase = "Metabolon", output_dir = getwd(), expt_name="pku")
pku_msea = pku_msea$report2[,c("MS", "SIZE", "NES", "NOM p-val", "FDR q-val")]
pku_msea[order(pku_msea$`NOM p-val`, decreasing = FALSE), ]

```

## Learn Partial-Correlation Disease-Specific Interaction Networks
``` {r learn-networks}
data("Miller2015")
data_mx = Miller2015[,grep("IEM_", colnames(Miller2015))]
ind = grep("x - ", rownames(data_mx))
data_mx = data_mx[-ind,]
refs = data_mx[,which(diagnoses$diagnosis=="No biochemical genetic diagnosis")]
ref_fill = (Miller2015$`Times identifed in all 200 samples`)/200
ref_fill = ref_fill[-ind]
refs2 = refs[which(ref_fill>0.8),]
cohorts = lapply(cohorts, function(i) i[which(i %in% colnames(Miller2015))])
for (type in c("ind", "noLatent")) {
  for (model in c("cob", "ga", "gamt")) { # "cit", "msud", "mma", "pa", "pku"
    for (fold in 1:length(cohorts[[model]])) {
      print(sprintf("Learning graphs for diag %s, fold %d...", model, fold))
      diag_pts = cohorts[[model]][-fold]
      print(diag_pts)
      fill.rate = apply(data_mx[,which(colnames(data_mx) %in% diag_pts)], 1, function(i) sum(is.na(i))/length(i))
      diag_data = data_mx[intersect(which(ref_fill>0.8), which(fill.rate<=0.20)), which(colnames(data_mx) %in% diag_pts)]
      diag_data = diag_data[which(rownames(diag_data) %in% rownames(refs2)),]
      if (type=="noLatent") {
        print("Disease only, no pruning, no latent variable embedded / differential networks.")
        diag_data = data.surrogateProfiles(data = diag_data, std = 1, useMnDiseaseProfile = FALSE, addHealthyControls = FALSE, ref_data = NULL)
      } else {
        print("Individual samples as training data. Latent variable embedding and network pruning.")
        diag_data = data.surrogateProfiles(data = diag_data, std = 1, useMnDiseaseProfile = FALSE, addHealthyControls = TRUE, ref_data = refs2)
      }
      print(dim(diag_data))
      
      # Disease Network: GLASSO approach
      inv_covmatt = huge(t(diag_data), method="glasso")
      inv_covmatt_select = huge.select(inv_covmatt, criterion = "stars")
      inv_covmat = as.matrix(inv_covmatt_select$icov[[which(inv_covmatt_select$lambda==inv_covmatt_select$opt.lambda)]])
      diag(inv_covmat) = 0;
      colnames(inv_covmat) = rownames(diag_data)
      ig = graph.adjacency(as.matrix(inv_covmat), mode="undirected", weighted=TRUE, add.colnames='name')
      V(ig)$name = rownames(diag_data)
      print(ig)
      
      if (type=="ind") {
        # Reference Network: GLASSO approach
        ref_data = data.surrogateProfiles(data = refs2, std = 1, useMnDiseaseProfile = FALSE, addHealthyControls = TRUE, ref_data = refs2)
        ref_data = ref_data[,-which(duplicated(colnames(ref_data)))]
        print(dim(ref_data))
        inv_covmatt = huge(t(ref_data), method="glasso", lambda = inv_covmatt_select$opt.lambda)
        inv_covmat = as.matrix(inv_covmatt$icov[[1]])
        diag(inv_covmat) = 0;
        colnames(inv_covmat) = rownames(ref_data)
        ig_ref = graph.adjacency(as.matrix(inv_covmat), mode="undirected", weighted=TRUE, add.colnames='name')
        V(ig_ref)$name = rownames(ref_data)
        print(ig_ref)
      
        ig_pruned = graph.naivePruning(ig, ig_ref)
        print(ig_pruned)
        save(ig, ig_ref, ig_pruned, file=sprintf("Methods_paper/loocv/loocv_nets/%s_foldNets/bg_%s_%s_fold%d.RData", type, model, type, fold))
        rm(ig, ig_pruned)
      } else {
        save(ig, file=sprintf("Methods_paper/loocv/loocv_nets/%s_foldNets/bg_%s_%s_fold%d.RData", type, model, type, fold))
        rm(ig)
      }
    }
  }
}

```


## Interpret Patient Metabolomics Profiles using CTD and Disease-Specific Networks
``` {r pre-compute-node-rankings}

#This section is done on the cluster 

#### Single-Node Diffusion Encoding Algorithm ######
# In order to get the metabolomics evidence for each disease network context using the single-node encoding algorithm. We will get pre-computed single-node diffusion node ranks for all metabolites in a given disease network model from the cluster.
# FILE HIERARCHY: 
#        graphs/ folder with all bg_[model]_[type]_fold[fold].RData files in it.
#        wrapper_ranks.r
#        getRanks.pbs
#        getRanksN.r
# DIRECTIONS: Run wrapper_ranks.r on cluster with for each pruned disease network. Set type="ind" since we want the 
#             node ranks for the pruned disease network. type="noPruning" is used for the disease+reference network and 
#             type="noLatent" is used for disease only network.
Rscript wrapper_ranks.r [model] [fold] [type] 
Rscript wrapper_ranks.r "CIT" 1 "ind"
Rscript wrapper_ranks.r "CIT" 2 "ind"
Rscript wrapper_ranks.r "CIT" 3 "ind"
Rscript wrapper_ranks.r "CIT" 4 "ind"
Rscript wrapper_ranks.r "CIT" 5 "ind"
Rscript wrapper_ranks.r "CIT" 6 "ind"
Rscript wrapper_ranks.r "CIT" 7 "ind"
Rscript wrapper_ranks.r "CIT" 8 "ind"
Rscript wrapper_ranks.r "CIT" 9 "ind"
# etc. for "GAMT", "MSUD", "MMA", "PA" and "PKU", too.

#---wrapper_ranks.r----
# the following script will batch generate pbs job request one node per job
args = commandArgs(trailingOnly=TRUE)
diag = args[1]
fold = as.numeric(args[2])
type = args[3]


require(igraph)
output_dir = sprintf("./diag%s%d", diag, fold)
str = sprintf("mkdir %s", output_dir)
system(str) 

require(R.utils)
require(igraph)
if (type=="noLatent") {
  ig = loadToEnv(sprintf("../graphs/%s_foldNets/bg_%s_%s_fold%d.RData", type, tolower(diag), type, fold))[["ig"]]
} else if (type=="ind") {
  ig = loadToEnv(sprintf("../graphs/%s_foldNets/bg_%s_%s_fold%d.RData", type, tolower(diag), type, fold))[["ig_pruned"]]
} else {
  ig = loadToEnv(sprintf("../graphs/%s_foldNets/bg_%s_%s_fold%d.RData", "ind", tolower(diag), "ind", fold))[["ig"]]
}
totalN = length(V(ig)$name)
print(sprintf("Total N = %d", totalN))

for (n in 1:totalN) {
  str = sprintf("qsub -v diag=%s,fold=%d,n=%d,type=%s getRanks.pbs", diag, fold, n, type)
  system(str, wait=FALSE)
  system("sleep 0.2")
}
  
ready=FALSE
last_sum = 0
while (!ready) {
  f = list.files(sprintf("./diag%s%d", diag, fold), pattern=".RData")
  print(sprintf("#permutation files ready = %d", length(f)))
  if (length(f)==totalN) {
    ready=TRUE
  } else {
    system("sleep 20")
    system("rm *.pbs.*")
    curr_sum = length(f)
    if (curr_sum > last_sum) {
      last_sum = curr_sum
    } 
  }
}
system("rm *.pbs.*")
  
# collate permutations into one R object
all_nodes = V(ig)$name
permutationByStartNode = list()
for (n in 1:length(all_nodes)) {
  load(sprintf("./diag%s%d/%d.RData", diag, fold, n))
  permutationByStartNode[[n]] = toupper(current_node_set)
}
names(permutationByStartNode) = all_nodes
save.image(file=sprintf("%sRanks_miller/%s%d-ranks.RData", type, toupper(diag), fold))
print("collate complete...")
str = sprintf("rm -r ./diag%s%d", diag, fold)
system(str)

#----getRanksN.r----
require(igraph)
args = commandArgs(trailingOnly=TRUE)
diag = args[1]
fold = as.numeric(args[2])
n = as.numeric(args[3])
type = args[4]

print(diag)
print(fold)
print(n)
print(type)


require(CTD)
require(R.utils)
if (type=="noLatent") {
  ig = loadToEnv(sprintf("../graphs/%s_foldNets/bg_%s_%s_fold%d.RData", type, tolower(diag), type, fold))[["ig"]]
} else if (type=="ind") {
  ig = loadToEnv(sprintf("../graphs/%s_foldNets/bg_%s_%s_fold%d.RData", type, tolower(diag), type, fold))[["ig_pruned"]]
} else {
  ig = loadToEnv(sprintf("../graphs/%s_foldNets/bg_%s_%s_fold%d.RData", "ind", tolower(diag), "ind", fold))[["ig"]]
}
print(ig)
V(ig)$name = tolower(V(ig)$name)
G = vector(mode="list", length=length(V(ig)$name))
names(G) = V(ig)$name
adjacency_matrix = list(as.matrix(get.adjacency(ig, attr="weight")))
p0=0.1
p1=0.9
thresholdDiff=0.01
all_nodes = tolower(V(ig)$name)
print(head(all_nodes))
current_node_set = singleNode.getNodeRanksN(n, G)
new_dir =  sprintf("./diag%s%d", diag, fold)
if (!dir.exists(new_dir)) {
  str = sprintf("mkdir %s", new_dir)
  system(str)
}
save(current_node_set, file=sprintf("./diag%s%d/%d.RData", diag, fold, n))

#----getRanks.pbs----
#    # Request 1 processors on 1 node
#    #PBS -l nodes=1:ppn=1
#    #Request x number of hours of walltime
#    #PBS -l walltime=1:00:00
#    #Request that regular output and terminal output go to the same file
#    #PBS -j oe
#    #PBS -m abe
#    module load R/3.3
#    cd metabolomics/9thCommitteeMeeting/loocv/singleNodeRanks
#    diag=${diag}
#    fold=${fold}
#    n=${n}
#    type=${type}
#    Rscript getRanksN.r $diag $fold $n $type > ranks:$diag-$fold-$n-$type.out
#    rm ranks:$diag-$fold-$n-$type.out


```

## Figure 7: Illustration of CTD's specificity, and patient module blowouts.
``` {r ctd-model-allpts}
setwd("/Users/lillian.rosa/OneDrive/MacFiles/9thCommitteeMeeting/Methods_paper/")
rm(list=ls())
require(R.utils)
require(CTD)
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
cohorts = list()
cohorts$mcc = diagnoses$id[which(diagnoses$diagnosis=="3-methylcrotonyl CoA carboxylase")]
cohorts$arg = diagnoses$id[which(diagnoses$diagnosis=="Argininemia")]
cohorts$cit = diagnoses$id[which(diagnoses$diagnosis=="Citrullinemia")]
cohorts$cob = diagnoses$id[which(diagnoses$diagnosis=="Cobalamin biosynthesis")]
cohorts$ga = diagnoses$id[which(diagnoses$diagnosis=="Glutaric Aciduria")]
cohorts$gamt = diagnoses$id[which(diagnoses$diagnosis=="Guanidinoacetate methyltransferase")]
cohorts$msud = diagnoses$id[which(diagnoses$diagnosis=="Maple syrup urine disease")]
cohorts$mma = diagnoses$id[which(diagnoses$diagnosis=="Methylmalonic aciduria")]
cohorts$otc = diagnoses$id[which(diagnoses$diagnosis=="Ornithine transcarbamoylase")]
cohorts$pa = diagnoses$id[which(diagnoses$diagnosis=="Propionic aciduria")]
cohorts$pku = diagnoses$id[which(diagnoses$diagnosis=="Phenylketonuria")]
cohorts$tmhle = diagnoses$id[which(diagnoses$diagnosis=="Trimethyllysine hydroxylase epsilon")]
cohorts$ref = diagnoses$id[which(diagnoses$diagnosis=="No biochemical genetic diagnosis")]
p0=0.1
p1=0.9
thresholdDiff=0.01
kmx=15
for (type in c("ind", "noPruning", "noLatent")) {
  for (model in c("cit", "msud", "mma", "pa", "pku")) {
    for (fold in 1:length(which(cohorts[[model]] %in% colnames(Miller2015)))) {
      if (type=="noPruning") {
        load(sprintf("loocv/loocv_nets/ind_foldNets/bg_%s_ind_fold%d.RData", model, fold))
        ig_pruned = ig
      } else {
        load(sprintf("loocv/loocv_nets/%s_foldNets/bg_%s_%s_fold%d.RData", type, model, type, fold))
        ig_pruned = ig
      }
      ranks = loadToEnv(sprintf("loocv/loocv_%s_runCTD/%s%d-ranks.RData", type, model, fold))[["permutationByStartNode"]]
      ranks = lapply(ranks, function(i) tolower(i))
      adjacency_matrix = list(as.matrix(get.adjacency(ig_pruned, attr="weight")))
      G = vector(mode="list", length=length(V(ig_pruned)$name))
      names(G) = V(ig_pruned)$name
      data_mx = data_mx[which(rownames(data_mx) %in% V(ig_pruned)$name), ]
      data_mx = data_mx[,which(colnames(data_mx) %in% colnames(Miller2015))]
      data.pvals = apply(data_mx, c(1,2), function(i) 2*pnorm(abs(i), lower.tail = FALSE))
      data.pvals = t(data.pvals)
      
      df = data.frame(ptID=character(), S=character(), lenS=numeric(), optT=numeric(),
                      fishers=numeric(), I0=numeric(), IA=numeric(), d=numeric(), stringsAsFactors = FALSE)
      r=1
      ptBSbyK = list()
      for (p in 1:ncol(data_mx)) {
        ptID = colnames(data_mx)[p]
        print(sprintf("Patient %d/%d...", p, ncol(data_mx)))
        if (ptID %in% unlist(cohorts)) {
          diag = names(cohorts)[which(unlist(lapply(cohorts, function(i) ptID %in% i)))]
          S = data_mx[order(abs(data_mx[,p]), decreasing = TRUE),p][1:kmx]
          ptBSbyK = singleNode.getPtBSbyK(names(S), ranks, num.misses = log2(length(G)))
          res = mle.getEncodingLength(ptBSbyK, data.pvals, ptID, G)
          for (k in 1:kmx) {
            df[r, "ptID"] = colnames(data_mx)[p]
            df[r, "diag"] = diag
            df[r, "S"] = paste(names(S)[1:k], collapse="/")
            df[r, "lenS"] = k
            df[r, "optT"] = res[k, "opt.T"]
            df[r, "fishers"] = res[k, "fishers.Info"]
            df[r, "I0"] = res[k, "IS.null"]
            df[r, "IA"] = res[k, "IS.alt"]
            df[r, "d"] = res[k, "d.score"]
            r = r + 1
          }
        }
      }
      save(ptBSbyK, df, file=sprintf("loocv/loocv_%s_runCTD/model_%s_%s_fold%d_kmx%d.RData", type, model, type, fold, kmx))
    }
  }
}

# Figure: Plot patient ID vs. bits for each disease-specific network
rm(list=ls())
setwd("/Users/lillian.rosa/OneDrive/MacFiles/9thCommitteeMeeting/")
require(ggplot2)
require(pROC)
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
cohorts = list()
cohorts$mcc = diagnoses$id[which(diagnoses$diagnosis=="3-methylcrotonyl CoA carboxylase")]
cohorts$arg = diagnoses$id[which(diagnoses$diagnosis=="Argininemia")]
cohorts$cit = diagnoses$id[which(diagnoses$diagnosis=="Citrullinemia")]
cohorts$cob = diagnoses$id[which(diagnoses$diagnosis=="Cobalamin biosynthesis")]
cohorts$ga = diagnoses$id[which(diagnoses$diagnosis=="Glutaric Aciduria")]
cohorts$gamt = diagnoses$id[which(diagnoses$diagnosis=="Guanidinoacetate methyltransferase")]
cohorts$msud = diagnoses$id[which(diagnoses$diagnosis=="Maple syrup urine disease")]
cohorts$mma = diagnoses$id[which(diagnoses$diagnosis=="Methylmalonic aciduria")]
cohorts$otc = diagnoses$id[which(diagnoses$diagnosis=="Ornithine transcarbamoylase")]
cohorts$pa = diagnoses$id[which(diagnoses$diagnosis=="Propionic aciduria")]
cohorts$pku = diagnoses$id[which(diagnoses$diagnosis=="Phenylketonuria")]
cohorts$tmhle = diagnoses$id[which(diagnoses$diagnosis=="Trimethyllysine hydroxylase epsilon")]
cohorts$ref = diagnoses$id[which(diagnoses$diagnosis=="No biochemical genetic diagnosis")]
for (model in c("pku", "pa", "mma", "msud", "cit")) {
  for (type in c("ind", "noLatent", "noPruning")) {
    print(sprintf("For model %s...", model))
    kmx=15
    df_all = data.frame(fold=numeric(), pt=numeric(), bits=numeric(), diag=character(), stringsAsFactors = FALSE)
    for (fold in 1:length(cohorts[[model]])) {
      load(sprintf("Methods_paper/loocv/loocv_%s_runCTD/model_%s_%s_fold%d_kmx%d.RData", type, model, type, fold, kmx))
      pts = unique(df$ptID)
      df = df[which(df$ptID %in% pts),]
      df_best = data.frame(pt=numeric(), ptID=character(), bits=numeric(), diag=character(), stringsAsFactors = FALSE)
      for (pt in 1:length(pts)) {
        pt_data = df[which(df$ptID==pts[pt]),]
        ptID = unique(df[which(df$ptID==pts[pt]), "ptID"])
        if (pt_data[1,"diag"]==model) {
          df_best[pt, "pt"] = which(cohorts[[model]]==ptID)
        }
        df_best[pt, "ptID"] = ptID
        df_best[pt, "bits"] = max(df[which(df$ptID==pts[pt]), "d"])-log2(nrow(pt_data))
        df_best[pt, "diag"] = unique(pt_data[,"diag"])
      }
      df_best$bits[which(df_best$bits<0)] = 0
      df_best$fold = rep(fold, nrow(df_best))
      df_all = rbind(df_all, df_best)
    }
    df_all = df_all[which(df_all$ptID %in% colnames(Miller2015)),]
    df_all$bits = -log2(p.adjust(2^-(df_all$bits), method="fdr"))
    
    # Visualize LOOCV signal and compare to off-target diseased test patients
    dff = df_all
    dff$loocv = rep(0, nrow(dff))
    dff$loocv[which(dff$pt==dff$fold)] = 1
    dff = dff[-intersect(which(dff$loocv==0), which(dff$diag==model)), ]
    b_bits = cbind(unique(dff$ptID), sapply(unique(dff$ptID), function(i) mean(dff[which(dff$ptID==i),"bits"])))
    dff = dff[-which(duplicated(dff$ptID)),]
    dff$diag[which(dff$diag=="ref")] = "z.ref"
    dff = dff[order(dff$ptID),]
    b_bits = b_bits[order(b_bits[,1]),]
    dff$bits = as.numeric(b_bits[,2])
    p2 = ggplot(dff, aes(x=diag, y=bits, fill=diag)) + geom_boxplot(size=2) + 
      geom_hline(yintercept=-log2(0.05)) +  theme(text = element_text(size=20)) + ggtitle(sprintf("%s (%s)", model, type))
    orca(p2, sprintf("Methods_paper/loocv/loocv_%s_runCTD/sn_%s_bg_clinical_%s_loocv.png", type, model, type), width = 1000, height = 500)
    
    d = dff$diag
    d[which(d!=model)] = 0
    d[which(d==model)] = 1
    d = as.numeric(d)
    auc = roc(d, dff$bits)
    print(sprintf("AUC (Model %s) = %.2f", toupper(model), auc$auc))
  }
}


# Patient module blowouts
rm(list=ls())
cohorts = lapply(cohorts, sort)
cohorts = lapply(cohorts, function(i) i[which(i %in% colnames(Miller2015))])
kmx=15
p0=0.1
p1=0.9
thresholdDiff=0.01
for (model in c("cit", "gamt", "mma", "msud", "pa", "pku")) {
  for (fold in 1:length(cohorts[[model]])) {
    load(sprintf("Methods_paper/loocv/loocv_nets/ind_foldNets/bg_%s_ind_fold%d.RData",model, fold)) 
    adjacency_matrix = list(as.matrix(get.adjacency(ig_pruned, attr="weight")))
    G = vector(mode="list", length=length(V(ig_pruned)$name))
    names(G) = V(ig_pruned)$name
    data_mx = data_mx[which(rownames(data_mx) %in% V(ig_pruned)$name), ]
    data.pvals = apply(data_mx, c(1,2), function(i) 2*pnorm(abs(i), lower.tail = FALSE))
    data.pvals = t(data.pvals)
    p = which(colnames(data_mx)==cohorts[[model]][fold]) 
    ptID = colnames(data_mx)[p]
    S = data_mx[order(abs(data_mx[,p]), decreasing = TRUE),p][1:kmx]
    # Single-node
    print("Single-node ranking...")
    ranks = list()
    for (i in 1:length(S)) {
      ind = which(names(G)==names(S)[i])
      ranks[[i]] = singleNode.getNodeRanksN(ind, G, names(S), num.misses = log2(length(G)))
    }
    names(ranks) = names(S)
    ptBSbyK = singleNode.getPtBSbyK(names(S), ranks)
    res = mle.getEncodingLength(ptBSbyK, data.pvals, ptID, G)
    print(res[which.max(res[,"d.score"]),])
    print(S[names(which(ptBSbyK[[which.max(res[,"d.score"])]]==1))])
    print(2^-res[which.max(res[,"d.score"]),"d.score"])
    print(2^-(res[which.max(res[,"d.score"]),"d.score"]-log2(nrow(res))))
    # This generates the module "blown out", which I then put into illustrator to make it look nice.
    mets = unique(c(names(S), names(ptBSbyK[[which.max(res[,"d.score"])]])))
    e = delete.vertices(ig, v=V(ig)$name[-which(V(ig)$name %in% mets)])
    reds = intersect(V(e)$name[which(V(e)$name %in% names(S))], names(S[which(S>0)]))
    blues = intersect(V(e)$name[which(V(e)$name %in% names(S))], names(S[which(S<0)]))
    V(e)$color[which(V(e)$name %in% reds)] = "red"
    V(e)$color[which(V(e)$name %in% blues)] = "blue"
    V(e)$color[-which(V(e)$name %in% names(S))] = "grey"
    cc = cluster_walktrap(e)
    communities(cc)
    weights <- ifelse(crossing(cc, e), 1, 5)
    layout <- layout_with_fr(e, weights=weights)
    png(sprintf("Methods_paper/loocv/blowouts/sn_%s_%s_module.png", model, ptID))
    plot.igraph(e, layout=layout, edge.width=50*abs(E(e)$weight))
    dev.off()
    svg(sprintf("Methods_paper/loocv/blowouts/sn_%s_%s_module.svg", model, ptID))
    plot.igraph(e, layout=layout, edge.width=50*abs(E(e)$weight))
    dev.off()
  }
}

```

## CTD vs. Partial Least Squares Regression
Precision is more focused in the positive class than in the negative class, it actually measures the probability of correct detection of positive values, while FPR and TPR (ROC metrics) measure the ability to distinguish between the classes.
``` {r pls_feature_select_compare}
rm(list=ls())
setwd("/Users/lillian.rosa/OneDrive/MacFiles/9thCommitteeMeeting/Methods_paper/")
require(R.utils)
require(CTD)
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
fill.rate = 1-(Miller2015$`Times identifed in all 200 samples`/200)
data_mx = data_mx[which(fill.rate<0.20), ]
data_mx = data_mx[-grep("x - ", rownames(data_mx)),]
cohorts = list()
cohorts$mcc = diagnoses$id[which(diagnoses$diagnosis=="3-methylcrotonyl CoA carboxylase")]
cohorts$arg = diagnoses$id[which(diagnoses$diagnosis=="Argininemia")]
cohorts$cit = diagnoses$id[which(diagnoses$diagnosis=="Citrullinemia")]
cohorts$cob = diagnoses$id[which(diagnoses$diagnosis=="Cobalamin biosynthesis")]
cohorts$ga = diagnoses$id[which(diagnoses$diagnosis=="Glutaric Aciduria")]
cohorts$gamt = diagnoses$id[which(diagnoses$diagnosis=="Guanidinoacetate methyltransferase")]
cohorts$msud = diagnoses$id[which(diagnoses$diagnosis=="Maple syrup urine disease")]
cohorts$mma = diagnoses$id[which(diagnoses$diagnosis=="Methylmalonic aciduria")]
cohorts$otc = diagnoses$id[which(diagnoses$diagnosis=="Ornithine transcarbamoylase")]
cohorts$pa = diagnoses$id[which(diagnoses$diagnosis=="Propionic aciduria")]
cohorts$pku = diagnoses$id[which(diagnoses$diagnosis=="Phenylketonuria")]
cohorts$tmhle = diagnoses$id[which(diagnoses$diagnosis=="Trimethyllysine hydroxylase epsilon")]
require(entropy)
whichRtoSelect = function(data_mx, classes) {
  rs = c()
  for (f in 1:nrow(data_mx)) {
    y2d = discretize2d(data_mx[f,], classes, ceiling(1+log2(ncol(data_mx))), ceiling(1+log2(ncol(data_mx))))
    rs = c(rs, mi.empirical(y2d))
  }
  return(quantile(rs, 0.95))
}
prunedIGraph = function(data_mx, classes, R) {
  ig_pruned = make_empty_graph(directed=FALSE)
  fr = c()
  for (f in 1:nrow(data_mx)) {
    y2d = discretize2d(data_mx[f,], classes, ceiling(1+log2(ncol(data_mx))), ceiling(1+log2(ncol(data_mx))))
    if(mi.empirical(y2d) > R) {
      fr = c(fr, rownames(data_mx)[f])
    }
  }
  ig_pruned = add.vertices(ig_pruned, nv=length(fr), attr=list(name=fr))
  
  
  L = data.frame(fi=character(), fj=character(), s=numeric(), stringsAsFactors = FALSE)
  data_mx_fr = data_mx[which(rownames(data_mx) %in% fr),]
  it = 1
  for (fi in 1:length(fr)) {
    for (fj in fi:length(fr)) {
      if (fi!=fj) {
        L[it,"fi"] = rownames(data_mx_fr)[fi]
        L[it,"fj"] = rownames(data_mx_fr)[fj]
        L[it,"s"] = cor(data_mx_fr[fi,], data_mx_fr[fj,], method="spearman")
        it = it + 1
      }
    }
  }
  L = L[order(abs(L$s), decreasing = TRUE),]
  
  it = 1
  disconnected = TRUE
  while (disconnected) {
    ig_pruned = add.edges(ig_pruned, e=c(L[it,"fi"], L[it, "fj"]), attr = list(weight=L[it,"s"]))
    it = it + 1
    disconnected = (!is.connected(ig_pruned))
  }
  
  return(ig_pruned)
}
fsfcn = function(ig_pruned, data_mx, classes, clusters) {
  S = c()
  for (c in 1:length(clusters)) {
    ig_cluster = induced_subgraph(ig_pruned, v=which(V(ig_pruned)$name %in% clusters[[c]]))
    data_mx_sub = data_mx[which(rownames(data_mx) %in% clusters[[c]]),]
    while (length(V(ig_cluster)$name)>0) {
      if (length(V(ig_cluster)$name)==1) {
        f_mx = V(ig_cluster)$name[1]
        data_mx_sub = as.matrix(data_mx_sub)
      } else {
        mi = c()
        for (f in 1:nrow(data_mx_sub)) {
          y2d = discretize2d(data_mx_sub[f,], classes, 10, 10)
          mi[f] = mi.empirical(y2d)
        }
        f_mx = rownames(data_mx_sub)[which.max(mi)]
      }
      f_n = names(unlist(ego(ig_cluster, 1, nodes=f_mx)))
      ig_cluster = delete.vertices(ig_cluster, v=which(V(ig_cluster)$name %in% c(f_mx, f_n)))
      data_mx_sub = data_mx_sub[-which(rownames(data_mx_sub) %in% c(f_mx, f_n)),]
      S = c(S, f_mx)
      print(sprintf("Size S = %d, Size ig_cluster = %d", length(S), length(V(ig_cluster)$name)))
    }
  }
  return(S)
}

ctd_module_select = list()
infomap_module_select = list()
gmo_module_select = list()
walktrap_module_select = list()
zscore_module_select = list()
for (model in c("cit", "msud", "mma", "pa", "pku")) { # "gamt", "otc"
  df_mn = apply(data_mx[,which(colnames(data_mx) %in% cohorts[[model]])], 1, function(i) mean(na.omit(i)))
  zscore_module_select[[model]] = names(df_mn[which(abs(df_mn)>2)])
  
  mdst = c()
  df_ctd = data.frame(ptID=character(), mets=character(), m=numeric(), stringsAsFactors = FALSE)
  for (fold in 1:length(cohorts[[model]])) {
    load(sprintf("loocv/loocv_nets/ind_foldNets/bg_%s_ind_fold%d.RData", model, fold))
    adjacency_matrix = list(as.matrix(get.adjacency(ig_pruned, attr="weight")))
    G = vector(mode="list", length=length(V(ig_pruned)$name))
    names(G) = V(ig_pruned)$name
    ranks = loadToEnv(sprintf("loocv/loocv_ind_runCTD/%s%d-ranks.RData", toupper(model), fold))[["permutationByStartNode"]]
    ranks = lapply(ranks, tolower)
    ptID = cohorts[[model]][fold]
    diag = names(cohorts)[which(unlist(lapply(cohorts, function(i) ptID %in% i)))]
    S = data_mx[order(abs(data_mx[,ptID]), decreasing = TRUE),ptID]
    S = S[which(abs(S)>2)]
    S = S[which(names(S) %in% names(G))]
    ptBSbyK = singleNode.getPtBSbyK(names(S), ranks, num.misses = log2(length(G)))
    res = mle.getEncodingLength(ptBSbyK, NULL, ptID, G)
    df_ctd[fold, "ptID"] = cohorts[[model]][fold]
    df_ctd[fold, "mets"] = paste(names(which(ptBSbyK[[which.max(res[,"d.score"])]]==1)), collapse="@")
    df_ctd[fold, "m"] = res[which.max(res[,"d.score"]), "d.score"]-log2(nrow(res))
    mdst = c(mdst, names(which(ptBSbyK[[which.max(res[,"d.score"])]]==1)))
  }
  ctd_module_select[[model]] = names(table(mdst)[table(mdst)>(length(cohorts[[model]])/2)])
  
  diag_data = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
  diag_data = diag_data[,which(colnames(diag_data) %in% c(cohorts[[model]], diagnoses$id[which(diagnoses$diagnosis=="No biochemical genetic diagnosis")]))]
  fill.rate = 1-(Miller2015$`Times identifed in all 200 samples`/200)
  diag_data = diag_data[which(fill.rate<0.2),]
  diag_data = diag_data[-grep("x - ", rownames(diag_data)), ]
  diags = colnames(diag_data)
  diags[-which(diags %in% cohorts[[model]])] = 0
  diags[which(diags %in% cohorts[[model]])] = 1
  diags = as.numeric(diags)
  R = whichRtoSelect(diag_data, diags)
  ig_pruned = prunedIGraph(diag_data, diags, R=R)
  
  # InfoMap: FSFCN
  cc = cluster_infomap(ig_pruned, e.weights = abs(E(ig_pruned)$weight), v.weights = NULL, nb.trials = 10, modularity = FALSE)
  infomap_module_select[[model]] = fsfcn(ig_pruned, diag_data, diags, communities(cc))

  # Walktrap: FSFCN
  cc = cluster_walktrap(ig_pruned)
  walktrap_module_select[[model]] = fsfcn(ig_pruned, diag_data, diags, communities(cc))
  
  # GMO: FSFCN
  E(ig_pruned)$weight = abs(E(ig_pruned)$weight)
  cc = cluster_fast_greedy(ig_pruned)
  gmo_module_select[[model]] = fsfcn(ig_pruned, diag_data, diags, communities(cc))
}


# CTD Global discrimination: CTD disease specific models call "yes" or "no" based on significance of patient's top metabolite perturbations.
setwd("/Users/lillian.rosa/OneDrive/MacFiles/9thCommitteeMeeting/Methods_paper/")
require(CTD)
require(pls)
require(pROC)
require(caret) # for varImp function
kmx=15
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
fill.rate = 1-(Miller2015$`Times identifed in all 200 samples`/200)
data_mx = data_mx[which(fill.rate<0.20), ]
data_mx = data_mx[-grep("x - ", rownames(data_mx)),]
for (model in c("cit", "msud", "mma", "pa", "pku")) {
  # Get CTD LOOCV signal 
  df_all = data.frame(fold=numeric(), pt=numeric(), bits=numeric(), diag=character(), stringsAsFactors = FALSE)
  for (fold in 1:length(cohorts[[model]])) {
    load(sprintf("loocv/loocv_ind_runCTD/model_%s_ind_fold%d_kmx%d.RData", model, fold, kmx))
    pts = unique(df$ptID)
    df = df[which(df$ptID %in% pts),]
    df_best = data.frame(pt=numeric(), ptID=character(), bits=numeric(), diag=character(), stringsAsFactors = FALSE)
    for (pt in 1:length(pts)) {
      pt_data = df[which(df$ptID==pts[pt]),]
      ptID = unique(df[which(df$ptID==pts[pt]), "ptID"])
      if (pt_data[1,"diag"]==model) {
        df_best[pt, "pt"] = which(cohorts[[model]]==ptID)
      }
      df_best[pt, "ptID"] = ptID
      df_best[pt, "bits"] = max(df[which(df$ptID==pts[pt]), "d"])-log2(nrow(pt_data))
      df_best[pt, "diag"] = unique(pt_data[,"diag"])
    }
    df_best$bits[which(df_best$bits<0)] = 0
    df_best$fold = rep(fold, nrow(df_best))
    df_all = rbind(df_all, df_best)
  }
  df_all = df_all[which(df_all$ptID %in% colnames(Miller2015)),]
  df_all$bits = -log2(p.adjust(2^-(df_all$bits), method="fdr"))
  df_all$loocv = rep(0, nrow(df_all))
  df_all$loocv[which(df_all$pt==df_all$fold)] = 1
  df_all = df_all[-intersect(which(df_all$loocv==0), which(df_all$diag==model)), ]
  b_bits = cbind(unique(df_all$ptID), sapply(unique(df_all$ptID), function(i) mean(df_all[which(df_all$ptID==i),"bits"])))
  df_all = df_all[-which(duplicated(df_all$ptID)),]
  df_all = df_all[order(df_all$ptID),]
  b_bits = b_bits[order(b_bits[,1]),]
  df_all$bits = as.numeric(b_bits[,2])

  data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
  fill.rate = 1-(Miller2015$`Times identifed in all 200 samples`/200)
  data_mx = data_mx[which(fill.rate<0.20), ]
  data_mx = data_mx[-grep("x - ", rownames(data_mx)),]
  data_mx = data_mx[,which(colnames(data_mx) %in% df_all$ptID)]
  data_mx = rbind(df_all$bits, data_mx)
  rownames(data_mx)[1] = "CTD.covariate"
  data_mx = t(apply(data_mx, 1, scale))
  colnames(data_mx) = df_all$ptID
  # Get diagnostic labels
  diags = colnames(data_mx)
  diags[-which(diags %in% cohorts[[model]])] = 0
  diags[which(diags %in% cohorts[[model]])] = 1
  data_mx = rbind(as.numeric(diags), data_mx)
  rownames(data_mx)[1] = "diag"
  data_mx = apply(data_mx, c(1,2), as.numeric)
  
  # PLS model w/ top z-score based feature selection
  df2 = data_mx[which(rownames(data_mx) %in% c("CTD.covariate", "diag", zscore_module_select[[model]])),]
  # PLS model w/ CTD feature selection
  df2_ctd = data_mx[which(rownames(data_mx) %in% c("CTD.covariate", "diag", ctd_module_select[[model]])),]
  # PLS model w/ Infomap feature selection
  df2_infomap = data_mx[which(rownames(data_mx) %in% c("CTD.covariate", "diag", infomap_module_select[[model]])),]
  # PLS model w/ GMO feature selection
  df2_gmo = data_mx[which(rownames(data_mx) %in% c("CTD.covariate", "diag", gmo_module_select[[model]])),]
  # PLS model w/ Walktrap feature selection
  df2_walktrap = data_mx[which(rownames(data_mx) %in% c("CTD.covariate", "diag", walktrap_module_select[[model]])),]
  
  dff_model = data.frame(pls_var_ctd=numeric(), pls_ctd_ctd=numeric(), pls_infomap_ctd=numeric(), 
                         pls_gmo_ctd=numeric(), pls_walktrap_ctd=numeric(), stringsAsFactors = FALSE)
  varImp_z_ctd = vector("list", length=ncol(df2))
  varImp_ctd_ctd = vector("list", length=ncol(df2))
  varImp_im_ctd = vector("list", length=ncol(df2))
  varImp_gmo_ctd = vector("list", length=ncol(df2))
  varImp_wt_ctd = vector("list", length=ncol(df2))
  for (it in 1:ncol(df2)) {
    print(it)
    isTrain = c(1:ncol(df2))[-it]
    # Top Zscore-based feature selection, plus CTD as covariate
    model_res = plsr(diag~., data = as.data.frame(t(df2[,isTrain])))
    varImp_z_ctd[[it]] = varImp(model_res)
    tst_data = df2[-1,-isTrain]
    model_tst =  predict(model_res, ncomp=model_res$ncomp, newdata=as.data.frame(t(tst_data)))
    dff_model[it, "pls_var_ctd"] = model_tst

    # CTD feature selection, plus CTD as covariate
    ctd_res = plsr(diag~., data = as.data.frame(t(df2_ctd[,isTrain])))
    varImp_ctd_ctd[[it]] = varImp(ctd_res)
    tst_data = df2_ctd[-1,-isTrain]
    ctd_tst = predict(ctd_res, ncomp=ctd_res$ncomp, newdata=as.data.frame(t(tst_data)))
    dff_model[it, "pls_ctd_ctd"] = ctd_tst
    
    # Infomap feature selection, plus CTD as covariate
    infomap_res = plsr(diag~., data = as.data.frame(t(df2_infomap[,isTrain])))
    varImp_im_ctd[[it]] = varImp(infomap_res)
    tst_data = df2_infomap[-1,-isTrain]
    infomap_tst = predict(infomap_res, ncomp=infomap_res$ncomp, newdata=as.data.frame(t(tst_data)))
    dff_model[it, "pls_infomap_ctd"] = infomap_tst
    
    # GMO feature selection, plus CTD as covariate
    gmo_res = plsr(diag~., data = as.data.frame(t(df2_gmo[,isTrain])))
    varImp_gmo_ctd[[it]] = varImp(gmo_res)
    tst_data = df2_gmo[-1,-isTrain]
    gmo_tst = predict(gmo_res, ncomp=gmo_res$ncomp, newdata=as.data.frame(t(tst_data)))
    dff_model[it, "pls_gmo_ctd"] = gmo_tst
    
    # walktrap feature selection, plus CTD as covariate
    walktrap_res = plsr(diag~., data = as.data.frame(t(df2_walktrap[,isTrain])))
    varImp_wt_ctd[[it]] = varImp(walktrap_res)
    tst_data = df2_walktrap[-1,-isTrain]
    walktrap_tst = predict(walktrap_res, ncomp=walktrap_res$ncomp, newdata=as.data.frame(t(tst_data)))
    dff_model[it, "pls_walktrap_ctd"] = walktrap_tst
  }
  
  mets2 = c()
  tmp = as.data.frame(varImp_z_ctd)
  mets2 = c(mets2, gsub("\\`", "", rownames(tmp)))
  tmp = as.data.frame(varImp_ctd_ctd)
  mets2 = c(mets2, gsub("\\`", "", rownames(tmp)))
  tmp = as.data.frame(varImp_im_ctd)
  mets2 = c(mets2, gsub("\\`", "", rownames(tmp)))
  tmp = as.data.frame(varImp_gmo_ctd)
  mets2 = c(mets2, gsub("\\`", "", rownames(tmp)))
  tmp = as.data.frame(varImp_wt_ctd)
  mets2 = c(mets2, gsub("\\`", "", rownames(tmp)))
  
  df_varImp2 = data.frame(varimp=c(apply(as.data.frame(varImp_z_ctd), 1, mean),
                                   apply(as.data.frame(varImp_ctd_ctd), 1, mean),
                                   apply(as.data.frame(varImp_im_ctd), 1, mean),
                                   apply(as.data.frame(varImp_gmo_ctd), 1, mean),
                                   apply(as.data.frame(varImp_wt_ctd), 1, mean)),
                          metabolite=mets2,
                          model=c(rep("Zscore", 1+length(zscore_module_select[[model]])),
                                  rep("CTD", 1+length(ctd_module_select[[model]])),
                                  rep("FSFCN-InfoMap", 1+length(infomap_module_select[[model]])),
                                  rep("FSFCN-GMO", 1+length(gmo_module_select[[model]])),
                                  rep("FSFCN-WalkTrap", 1+length(walktrap_module_select[[model]]))), stringsAsFactors = FALSE)
  
  for (mm in c("CTD", "FSFCN-GMO", "FSFCN-InfoMap", "FSFCN-WalkTrap", "Zscore")) {
    dff = df_varImp2[which(df_varImp2$model==mm),]
    rownames(dff) = dff$metabolite
    percentile = 1 - length(which(dff[,"varimp"]>=dff["CTD.covariate", "varimp"]))/length(df_varImp2[which(df_varImp2$model=="Zscore"),"varimp"])
    mets_who_beat = dff[which(dff[,"varimp"]>dff["CTD.covariate", "varimp"]),]
    print(sprintf("Model %s placed CTD.covariate in %f-th percentile, rank was %d/%d. Mets who beat were %s", mm, percentile, nrow(mets_who_beat)+1, length(dff$metabolite), paste(mets_who_beat[,"metabolite"][-1], collapse=", ")))
  }
  png(sprintf("../Methods_paper/pls/pls-%s-varimp2.png", model), width=2500, height=2000, res=300)
  ggplot(df_varImp2, aes(x=metabolite, y=varimp, group=model, colour=model)) + geom_line() + theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle(sprintf("Variable Importance for %s", toupper(model)))
  dev.off()
  
  print(sprintf("For %s model...", toupper(model)))
  # Calculate AUC using pROC, since you cannot calculate directly with TP, TN, FP, FN
  plsvar_ctd_auc = roc(diags, dff_model[,"pls_var_ctd"])
  plsctd_ctd_auc = roc(diags, dff_model[,"pls_ctd_ctd"])
  plsinfomap_ctd_auc = roc(diags, dff_model[,"pls_infomap_ctd"])
  plsgmo_ctd_auc = roc(diags, dff_model[,"pls_gmo_ctd"])
  plswalktrap_ctd_auc = roc(diags, dff_model[,"pls_walktrap_ctd"])
  ctd_auc = roc(diags, df_all$bits)
  print(sprintf("CTD AUC = %.3f", ctd_auc$auc))
  print(sprintf("PLS.var+CTD AUC = %.3f", plsvar_ctd_auc$auc))
  print(sprintf("PLS.ctd+CTD AUC = %.3f", plsctd_ctd_auc$auc))
  print(sprintf("PLS.infomap+CTD AUC = %.3f", plsinfomap_ctd_auc$auc))
  print(sprintf("PLS.gmo+CTD AUC = %.3f", plsgmo_ctd_auc$auc))
  print(sprintf("PLS.walktrap+CTD AUC = %.3f", plswalktrap_ctd_auc$auc))
  
  plsvar_ctd_auc2 = coords(plsvar_ctd_auc, "best", ret=c("threshold", "specificity", "accuracy", "precision", "recall"))
  plsctd_ctd_auc2 = coords(plsctd_ctd_auc, "best", ret=c("threshold", "specificity", "accuracy", "precision", "recall"))
  plsinfomap_ctd_auc2 = coords(plsinfomap_ctd_auc, "best", ret=c("threshold", "specificity", "accuracy", "precision", "recall"))
  plsgmo_ctd_auc2 = coords(plsgmo_ctd_auc, "best", ret=c("threshold", "specificity", "accuracy", "precision", "recall"))
  plswalktrap_ctd_auc2 = coords(plswalktrap_ctd_auc, "best", ret=c("threshold", "specificity", "accuracy", "precision", "recall"))
  ctd_auc2 = coords(ctd_auc, "best", ret=c("threshold", "specificity", "accuracy", "precision", "recall"))
  print(plsvar_ctd_auc2)
  print(plsctd_ctd_auc2)
  print(plsinfomap_ctd_auc2)
  print(plsgmo_ctd_auc2)
  print(plswalktrap_ctd_auc2)
  print(ctd_auc2)
}


# Get single variable AUC's and effect sizes
cit_mets = unique(c(ctd_module_select$cit, zscore_module_select$cit, infomap_module_select$cit, gmo_module_select$cit, walktrap_module_select$cit))
msud_mets = unique(c(ctd_module_select$msud, zscore_module_select$msud, infomap_module_select$msud, gmo_module_select$msud, walktrap_module_select$msud))
mma_mets = unique(c(ctd_module_select$mma, zscore_module_select$mma, infomap_module_select$mma, gmo_module_select$mma, walktrap_module_select$mma))
pa_mets = unique(c(ctd_module_select$pa, zscore_module_select$pa, infomap_module_select$pa, gmo_module_select$pa, walktrap_module_select$pa))
pku_mets = unique(c(ctd_module_select$pku, zscore_module_select$pku, infomap_module_select$pku, gmo_module_select$pku, walktrap_module_select$pku))

require(effsize)
data(Miller2015)
data_mx = as.matrix(Miller2015[,grep("IEM_", colnames(Miller2015))])
fill.rate = 1-(Miller2015$`Times identifed in all 200 samples`/200)
data_mx = data_mx[which(fill.rate<0.20), ]
data_mx = data_mx[-grep("x - ", rownames(data_mx)),]

diags = colnames(data_mx)
diags[which(diags %in% diagnoses$id[which(diagnoses$diagnosis=="Citrullinemia")])] = "cit"
diags[which(diags %in% diagnoses$id[which(diagnoses$diagnosis=="Guanidinoacetate methyltransferase")])] = "gamt"
diags[which(diags %in% diagnoses$id[which(diagnoses$diagnosis=="Maple syrup urine disease")])] = "msud"
diags[which(diags %in% diagnoses$id[which(diagnoses$diagnosis=="Methylmalonic aciduria")])] = "mma"
diags[which(diags %in% diagnoses$id[which(diagnoses$diagnosis=="Propionic aciduria")])] = "pa"
diags[which(diags %in% diagnoses$id[which(diagnoses$diagnosis=="Phenylketonuria")])] = "pku"
diags[which(diags %in% diagnoses$id[which(diagnoses$diagnosis=="Ornithine transcarbamoylase")])] = "otc"
diags[which(diags %in% diagnoses$id[which(diagnoses$diagnosis %in% c("3-methylcrotonyl CoA carboxylase", "3-OH-3methylglutaryl (HMG) CoA lyase", "Argininemia", "Argininosuccinic acid lyase", "Cobalamin biosynthesis", "Glutaric Aciduria", "Holocarboxylase", "Homocystinuria", "Isovaleric aciduria", "Lysinuric protein intolerance", "Medium chain acyl-CoA dehydrogenase", "Thymidine Phosphorylase", "Trimethyllysine hydroxylase epsilon", "Very-long chain acyl-CoA dehydrogenase", "No biochemical genetic diagnosis"))])] = "other"
cohens_d = list()
discrimination = list()
mn_zscore = list()
for (model in c("cit", "msud", "mma", "pa", "pku")) {
  i = which(c("cit", "msud", "mma", "pa", "pku")==model)
  select_mets = list(cit_mets, msud_mets, mma_mets, pa_mets, pku_mets)[[i]]
  print(length(select_mets))
  cd = vector("numeric", length(select_mets))
  dis = vector("numeric", length(select_mets))
  for (r in 1:length(select_mets)) {
    print(sprintf("%d / %d...", r, length(select_mets)))
    z_cases = as.matrix(data_mx[which(rownames(data_mx) %in% select_mets[r]), which(diags==model)])
    z_cntl = as.matrix(data_mx[which(rownames(data_mx) %in% select_mets[r]), which(diags!=model)])
    tmp = cohen.d(d = c(z_cases, z_cntl), f=c(rep("cases", length(z_cases)), rep("cntl", length(z_cntl))))
    cd[r] = tmp$estimate
    
    diag = colnames(data_mx)
    diag[-which(diag %in% cohorts[[model]])] = 0
    diag[which(diag %in% cohorts[[model]])] = 1
    diag = as.numeric(diag)
    dis[r] = roc(diag, data_mx[select_mets[r],])$auc
  }
  names(cd) = select_mets
  names(dis) = select_mets
  df_mn = apply(data_mx[,which(colnames(data_mx) %in% cohorts[[model]])], 1, function(i) mean(na.omit(i)))
  df_mn = df_mn[order(names(df_mn))]
  cohens_d[[model]] = cd
  discrimination[[model]] = dis
  mn_zscore[[model]] = df_mn[sort(select_mets)]
}

```